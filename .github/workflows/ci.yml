name: CI

on:
  push:
    branches: ["main", "refactor/project-structure"]
  pull_request:
    branches: ["main"]

env:
  PROJECT_ID: production-466308
  REGION: europe-west1
  REPOSITORY: aksio-prod-registry
  SERVICE: aksio-backend

permissions:
  pull-requests: write
  contents: write
  id-token: write  # Required for Workload Identity Federation
  
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Build docker image and run tests
        run: |
          # Build the Docker image first
          docker build -t aksio-backend-test .
          
          # Use the minimal CI docker-compose configuration
          docker compose -f docker-compose.ci.yml down -v
          docker compose -f docker-compose.ci.yml build
          
          # Start services
          docker compose -f docker-compose.ci.yml up -d db redis
          
          # Wait for services to be ready
          echo "Waiting for PostgreSQL to be ready..."
          timeout 60 bash -c 'until docker compose -f docker-compose.ci.yml exec -T db pg_isready -U aksio_user -d aksio_db; do sleep 2; done'
          
          echo "Waiting for Redis to be ready..."
          timeout 30 bash -c 'until docker compose -f docker-compose.ci.yml exec -T redis redis-cli ping; do sleep 1; done'
          
          # Run the backend with tests
          docker compose -f docker-compose.ci.yml up --abort-on-container-exit backend
          
          # Get the exit code
          EXIT_CODE=$(docker compose -f docker-compose.ci.yml ps -q backend | xargs docker inspect --format='{{.State.ExitCode}}')
          
          # Clean up
          docker compose -f docker-compose.ci.yml down -v
          
          # Exit with the same code as the tests
          exit $EXIT_CODE

  push-image:
    name: Build and Push Docker Image to Artifact Registry
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation
      
    # Only runs if CI was successful and on specified branches
    needs: [build]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/refactor/project-structure') && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          # Verify authentication first
          gcloud auth list
          gcloud config list
          
          # Configure Docker for Artifact Registry
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Verify Artifact Registry access
        run: |
          # Test access to the repository
          gcloud artifacts repositories describe ${REPOSITORY} \
            --location=${REGION} \
            --project=${PROJECT_ID}

      - name: Build and Push Docker image
        run: |
          IMAGE_TAG="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${SERVICE}:${GITHUB_SHA}"
          IMAGE_LATEST="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${SERVICE}:latest"
          
          # Build the production image
          docker build -f Dockerfile.prod -t ${IMAGE_TAG} -t ${IMAGE_LATEST} .
          
          # Push both tags with retry logic
          for i in {1..3}; do
            if docker push ${IMAGE_TAG} && docker push ${IMAGE_LATEST}; then
              echo "✅ Successfully pushed images"
              break
            else
              echo "❌ Push attempt $i failed, retrying..."
              sleep 10
            fi
          done
          
  dependabot:
    name: 'Dependabot'
    # After the E2E and build jobs, if one of them fails, it won't merge the PR.
    needs: [build] 
    runs-on: ubuntu-latest
    # Detect that the PR author is dependabot
    if: ${{ github.actor == 'dependabot[bot]' && github.event_name == 'pull_request'}} 
    steps:
      - name: Enable auto-merge for Dependabot PRs
        # Use Github CLI to merge automatically the PR
        run: gh pr merge --auto --merge "$PR_URL" 
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
